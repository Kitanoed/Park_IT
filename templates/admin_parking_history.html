{% extends 'base.html' %}
{% load static %}

{% block title %}Admin - Parking History{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap');

  :root {
    --brand-red: #b71c1c;
    --brand-orange: #f57c00;
    --brand-gradient: linear-gradient(135deg, #b71c1c 0%, #f57c00 100%);
    
    --win-red: #ff5f57;
    --win-yellow: #ffbd2e;
    --win-green: #28c840;
    
    --surface: #ffffff;
    --surface-elevated: #fafbfc;
    --border: #e5e7eb;
    --border-light: #f3f4f6;
    --text: #111827;
    --text-secondary: #4b5563;
    --muted: #6b7280;
    --canvas-bg: #f8fafc;
  }

  * { box-sizing: border-box; }

  body { 
    background: var(--canvas-bg); 
    font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
    margin: 0;
  }

  .dashboard-wrap {
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
  }

  .app {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 20px;
    min-height: calc(100vh - 80px);
  }

  /* Sidebar */
  .sidebar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    height: fit-content;
    position: sticky;
    top: 20px;
  }

  .brand {
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .dots-container {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    transition: transform 0.2s;
  }
  .dot:hover { transform: scale(1.2); }
  .dot.red { background: var(--win-red); }
  .dot.yellow { background: var(--win-yellow); }
  .dot.green { background: var(--win-green); }

  .park-brand {
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 700;
    letter-spacing: -0.5px;
    font-size: 22px;
    line-height: 1;
  }
  .park-brand .p1 { color: var(--brand-red); }
  .park-brand .p2 { color: #ffb400; }
  .brand-subtitle { 
    font-weight: 500; 
    color: var(--muted); 
    font-size: 12px; 
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .nav {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
  }

  .nav a {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid transparent;
    color: var(--text);
    background: var(--surface);
    transition: all 0.2s ease;
    font-weight: 500;
    font-size: 14px;
  }

  .nav a:hover {
    background: var(--surface-elevated);
    border-color: var(--border);
    transform: translateX(4px);
  }

  .nav a.active {
    background: var(--brand-gradient);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);
  }

  .nav-icon {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    background: var(--surface-elevated);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }
  
  .nav-icon i {
    color: var(--text);
  }

  .nav a.active .nav-icon {
    background: rgba(255,255,255,0.2);
  }
  
  .nav a.active .nav-icon i {
    color: #fff;
  }

  .spacer { flex: 1; }

  .profile {
    padding: 14px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--surface);
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .profile:hover {
    border-color: var(--brand-red);
    background: #fff5f5;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--brand-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
  }

  .profile-info .nm { font-weight: 600; font-size: 13px; color: var(--text); }
  .profile-info .em { font-size: 11px; color: var(--muted); }

  /* Modal Overlay */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal-overlay.show { display: flex; }

  .account-modal {
    background: #fff;
    border-radius: 16px;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    position: relative;
    animation: modalIn 0.3s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin: 0;
  }

  .close-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--surface-elevated);
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .close-btn:hover {
    background: #fee2e2;
    color: var(--brand-red);
  }

  .modal-body { padding: 24px; }

  .form-field { margin-bottom: 20px; }
  .form-field:last-child { margin-bottom: 0; }

  .field-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .field-input {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    color: var(--text);
    background: var(--surface-elevated);
    font-family: inherit;
    transition: all 0.2s;
  }

  .field-input:focus {
    outline: none;
    border-color: var(--brand-red);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.1);
  }

  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
  }

  .logout-btn-modal {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    background: var(--brand-gradient);
    color: #fff;
    transition: all 0.2s;
    font-family: inherit;
  }

  .logout-btn-modal:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);
  }

  /* Main Content */
  .main {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Page Header */
  .page-header {
    margin-bottom: 4px;
  }

  .page-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--text);
    margin: 0 0 6px;
    letter-spacing: -0.5px;
  }

  .page-subtitle {
    font-size: 14px;
    color: var(--muted);
    margin: 0;
  }

  /* Card */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-light);
  }

  .card-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-title-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--surface-elevated);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  /* Filter Section */
  .filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .filter-group-full {
    grid-column: 1 / -1;
  }

  .filter-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .filter-input,
  .filter-select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    color: var(--text);
    background: var(--surface);
    font-family: inherit;
    transition: all 0.2s;
  }

  .filter-input:focus,
  .filter-select:focus {
    outline: none;
    border-color: var(--brand-red);
    box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.1);
  }

  .filter-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 16px;
  }

  .btn {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }

  .btn-primary {
    background: var(--brand-gradient);
    color: #fff;
    box-shadow: 0 2px 8px rgba(183, 28, 28, 0.25);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(183, 28, 28, 0.35);
  }

  .btn-secondary {
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    border-color: var(--brand-red);
    color: var(--brand-red);
  }

  /* Table Section */
  .table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .table-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin: 0;
  }

  .table-info {
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
  }

  .table-responsive {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 12px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    min-width: 900px;
  }

  th, td {
    padding: 14px 16px;
    text-align: left;
    color: var(--text);
  }

  th {
    font-weight: 700;
    background: var(--surface-elevated);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
  }

  td {
    border-bottom: 1px solid var(--border-light);
  }

  .sortable {
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
  }

  .sortable:hover {
    background: #f0f1f3;
  }

  .sort-active {
    background: #fff5f5;
  }

  .sort-indicator {
    margin-left: 4px;
    color: var(--brand-red);
    font-weight: 700;
  }

  tbody tr {
    transition: background 0.2s;
  }

  tbody tr:hover {
    background: var(--surface-elevated);
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* Status Badge */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .status-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }

  .status-completed {
    background: #ecfdf5;
    color: #065f46;
    border: 1px solid #bbf7d0;
  }

  .status-completed::before {
    background: #10b981;
  }

  .status-active,
  .status-incomplete {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .status-active::before,
  .status-incomplete::before {
    background: #f59e0b;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .no-results {
    text-align: center;
    padding: 48px 24px;
    color: var(--muted);
    font-size: 14px;
  }

  .loading-spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--brand-red);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin-right: 10px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Pagination */
  .pagination-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }

  .pagination-info {
    font-size: 14px;
    color: var(--text);
    font-weight: 600;
  }

  .pagination-buttons {
    display: flex;
    gap: 12px;
  }

  .btn-pagination {
    padding: 10px 18px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--surface);
    color: var(--text);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }

  .btn-pagination:hover:not(:disabled) {
    border-color: var(--brand-red);
    color: var(--brand-red);
    transform: translateY(-1px);
  }

  .btn-pagination:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .app { grid-template-columns: 1fr; }
    .sidebar { position: relative; top: 0; }
    .filter-row { grid-template-columns: 1fr; }
  }
</style>

<div class="dashboard-wrap">
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="dots-container">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div>
          <div class="park-brand">
            <span class="p1">Park</span><span class="p2">IT!</span>
          </div>
          <div class="brand-subtitle">Admin Portal</div>
        </div>
      </div>

      <nav class="nav">
        <a href="{% url 'dashboard' %}">
          <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'parking_spaces' %}">
          <span class="nav-icon"><i class="fas fa-parking"></i></span>
          <span>Parking Spaces</span>
        </a>
        <a class="active" href="{% url 'admin_parking_history' %}">
          <span class="nav-icon"><i class="fas fa-clipboard-list"></i></span>
          <span>Parking History</span>
        </a>
        <a href="{% url 'advanced_reports' %}">
          <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
          <span>Advanced Reports</span>
        </a>
        <a href="{% url 'manage_users' %}">
          <span class="nav-icon"><i class="fas fa-users"></i></span>
          <span>Manage Users</span>
        </a>
      </nav>

      <div class="spacer"></div>

      <div class="profile" id="profileTrigger">
        <div class="avatar">{{ full_name|slice:":1"|upper|default:"A" }}</div>
        <div class="profile-info">
          <div class="nm">{{ full_name|default:"Admin" }}</div>
          <div class="em">{{ email|default:"admin@parkit.com" }}</div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="page-header">
        <h1 class="page-title">Parking History</h1>
        <p class="page-subtitle">View and filter parking session records</p>
      </div>

      <!-- Filter Section -->
      <div class="card">
        <form id="filter-form">
          <div class="filter-row">
            <div class="filter-group filter-group-full">
              <label for="search-plate" class="filter-label">Search by Plate Number</label>
              <input 
                type="text" 
                id="search-plate" 
                class="filter-input" 
                placeholder="Enter license plate number..."
                autocomplete="off"
              />
            </div>
          </div>

          <div class="filter-row" style="margin-top: 16px;">
            <div class="filter-group">
              <label for="date-from" class="filter-label">From Date</label>
              <input type="date" id="date-from" class="filter-input" />
            </div>
            
            <div class="filter-group">
              <label for="date-to" class="filter-label">To Date</label>
              <input type="date" id="date-to" class="filter-input" />
            </div>

            <div class="filter-group">
              <label for="lot-filter" class="filter-label">Location</label>
              <select id="lot-filter" class="filter-select">
                <option value="">All Lots</option>
                {% for lot_name in parking_lots %}
                <option value="{{ lot_name }}">{{ lot_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="filter-group">
              <label for="status-filter" class="filter-label">Status</label>
              <select id="status-filter" class="filter-select">
                <option value="">All Status</option>
                <option value="Completed">Completed</option>
                <option value="Incomplete">Incomplete</option>
              </select>
            </div>
          </div>

          <div class="filter-actions">
            <button type="button" id="clear-filters" class="btn btn-secondary">Clear Filters</button>
            <button type="button" id="apply-filters" class="btn btn-primary">Apply Filters</button>
          </div>
        </form>
      </div>

      <!-- Table Section -->
      <div class="card">
        <div class="table-header">
          <h3 class="table-title">Parking Sessions</h3>
          <div class="table-info" id="results-count">Showing 0 results</div>
        </div>

        <div class="table-responsive">
          <table id="parking-history-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="session_id">
                  Session ID <span class="sort-indicator"></span>
                </th>
                <th class="sortable" data-sort="plate_number">
                  Plate Number <span class="sort-indicator"></span>
                </th>
                <th class="sortable" data-sort="lot_name">
                  Location <span class="sort-indicator"></span>
                </th>
                <th class="sortable" data-sort="entry_time">
                  Entry Time <span class="sort-indicator"></span>
                </th>
                <th class="sortable" data-sort="exit_time">
                  Exit Time <span class="sort-indicator"></span>
                </th>
                <th class="sortable" data-sort="duration">
                  Duration <span class="sort-indicator"></span>
                </th>
                <th class="sortable" data-sort="status">
                  Status <span class="sort-indicator"></span>
                </th>
              </tr>
            </thead>
            <tbody id="table-body">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <div id="pagination-controls" class="pagination-wrapper">
          <div class="pagination-info">
            <span id="page-info">Page 1 of 1</span>
          </div>
          <div class="pagination-buttons">
            <button type="button" id="prev-page" class="btn-pagination" disabled>Previous</button>
            <button type="button" id="next-page" class="btn-pagination" disabled>Next</button>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
(function() {
  'use strict';

  const API_BASE_URL = '{% url "parking_history_api" %}';
  
  let currentSessions = [];
  let currentPage = 1;
  const itemsPerPage = 10;
  let totalCount = 0;
  let totalPages = 0;
  let currentSort = { field: null, direction: 'asc' };
  let isLoading = false;
  let searchTimeout = null;

  const searchInput = document.getElementById('search-plate');
  const dateFromInput = document.getElementById('date-from');
  const dateToInput = document.getElementById('date-to');
  const lotFilter = document.getElementById('lot-filter');
  const statusFilter = document.getElementById('status-filter');
  const applyFiltersBtn = document.getElementById('apply-filters');
  const clearFiltersBtn = document.getElementById('clear-filters');
  const tableBody = document.getElementById('table-body');
  const resultsCount = document.getElementById('results-count');
  const prevPageBtn = document.getElementById('prev-page');
  const nextPageBtn = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');
  const sortableHeaders = document.querySelectorAll('.sortable');

  function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'â€”';
    const date = new Date(dateTimeString);
    return date.toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  }

  async function fetchParkingHistory() {
    if (isLoading) return;
    
    isLoading = true;
    setLoadingState(true);
    
    try {
      const params = new URLSearchParams();
      
      if (searchInput.value.trim()) params.append('search_plate', searchInput.value.trim());
      if (dateFromInput.value) params.append('date_from', dateFromInput.value);
      if (dateToInput.value) params.append('date_to', dateToInput.value);
      if (lotFilter.value) params.append('lot_name', lotFilter.value);
      if (statusFilter.value) params.append('status', statusFilter.value);
      
      // Ensure currentPage is at least 1
      if (currentPage < 1) currentPage = 1;
      params.append('page', currentPage.toString());
      params.append('page_size', itemsPerPage.toString());
      
      const response = await fetch(`${API_BASE_URL}?${params.toString()}`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }
      
      const data = await response.json();
      
      currentSessions = data.results || [];
      totalCount = data.count || 0;
      totalPages = data.total_pages || 0;
      // Don't override currentPage if we're navigating - only use data.page if it's different
      if (data.page && Math.abs(data.page - currentPage) <= 1) {
        currentPage = data.page;
      }
      
      if (currentSort.field) {
        sortSessions(currentSort.field);
      } else {
        renderTable();
      }
      updatePagination();
      
    } catch (error) {
      console.error('Error fetching parking history:', error);
      showError('Failed to load parking history: ' + error.message);
      currentSessions = [];
      totalCount = 0;
      totalPages = 0;
      renderTable();
      updatePagination();
    } finally {
      isLoading = false;
      setLoadingState(false);
    }
  }

  function setLoadingState(loading) {
    if (loading) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="7" class="no-results">
            <span class="loading-spinner"></span>
            Loading parking history...
          </td>
        </tr>
      `;
      applyFiltersBtn.disabled = true;
      clearFiltersBtn.disabled = true;
      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;
    } else {
      applyFiltersBtn.disabled = false;
      clearFiltersBtn.disabled = false;
      updatePagination();
    }
  }

  function showError(message) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="7" class="no-results" style="color:#991b1b;">
          <strong>${message}</strong>
          <div style="font-size:12px;margin-top:8px;color:var(--muted);">Please try again or contact support.</div>
        </td>
      </tr>
    `;
  }

  function applyFilters() {
    currentPage = 1;
    fetchParkingHistory();
  }

  function clearFilters() {
    searchInput.value = '';
    dateFromInput.value = '';
    dateToInput.value = '';
    lotFilter.value = '';
    statusFilter.value = '';
    currentPage = 1;
    fetchParkingHistory();
  }

  function sortSessions(field) {
    if (currentSort.field === field) {
      currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      currentSort.field = field;
      currentSort.direction = 'asc';
    }

    const sortedSessions = [...currentSessions].sort((a, b) => {
      let aVal = a[field];
      let bVal = b[field];

      if (aVal === null || aVal === undefined) aVal = '';
      if (bVal === null || bVal === undefined) bVal = '';

      if (field === 'entry_time' || field === 'exit_time') {
        aVal = aVal ? new Date(aVal).getTime() : 0;
        bVal = bVal ? new Date(bVal).getTime() : 0;
      }

      if (typeof aVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }

      if (currentSort.direction === 'asc') {
        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      } else {
        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
      }
    });

    currentSessions = sortedSessions;
    updateSortIndicators();
    renderTable();
    updatePagination();
  }

  function updateSortIndicators() {
    sortableHeaders.forEach(header => {
      const indicator = header.querySelector('.sort-indicator');
      const field = header.getAttribute('data-sort');
      
      if (field === currentSort.field) {
        indicator.textContent = currentSort.direction === 'asc' ? ' â†‘' : ' â†“';
        header.classList.add('sort-active');
      } else {
        indicator.textContent = '';
        header.classList.remove('sort-active');
      }
    });
  }

  function renderTable() {
    tableBody.innerHTML = '';

    if (currentSessions.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="7" class="no-results">
            <div style="font-size:32px;margin-bottom:12px;">ðŸ“­</div>
            No parking sessions found matching your filters.
          </td>
        </tr>
      `;
      return;
    }

    currentSessions.forEach(session => {
      const row = document.createElement('tr');
      const statusClass = (session.status || 'Incomplete').toLowerCase();
      
      row.innerHTML = `
        <td style="font-family:'JetBrains Mono',monospace;color:var(--muted);font-size:12px;">#${session.session_id || 'â€”'}</td>
        <td><strong style="font-family:'JetBrains Mono',monospace;">${session.plate_number || 'â€”'}</strong></td>
        <td>${session.lot_name || 'â€”'}</td>
        <td>${formatDateTime(session.entry_time)}</td>
        <td>${session.exit_time ? formatDateTime(session.exit_time) : 'â€”'}</td>
        <td><strong>${session.duration || '0h 0m'}</strong></td>
        <td><span class="status-badge status-${statusClass}">${session.status || 'Incomplete'}</span></td>
      `;
      
      tableBody.appendChild(row);
    });

    resultsCount.textContent = `Showing ${totalCount} result${totalCount !== 1 ? 's' : ''}`;
  }

  function updatePagination() {
    const totalPagesDisplay = totalPages || 1;
    pageInfo.textContent = `Page ${currentPage} of ${totalPagesDisplay}`;
    
    // Update previous button
    prevPageBtn.disabled = currentPage <= 1 || isLoading || totalPages === 0;
    
    // Update next button
    nextPageBtn.disabled = currentPage >= totalPagesDisplay || isLoading || totalPages === 0;
    
    // Add visual feedback
    if (prevPageBtn.disabled) {
      prevPageBtn.style.opacity = '0.5';
      prevPageBtn.style.cursor = 'not-allowed';
    } else {
      prevPageBtn.style.opacity = '1';
      prevPageBtn.style.cursor = 'pointer';
    }
    
    if (nextPageBtn.disabled) {
      nextPageBtn.style.opacity = '0.5';
      nextPageBtn.style.cursor = 'not-allowed';
    } else {
      nextPageBtn.style.opacity = '1';
      nextPageBtn.style.cursor = 'pointer';
    }
  }

  // Event Listeners
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => applyFilters(), 500);
  });

  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(searchTimeout);
      applyFilters();
    }
  });

  applyFiltersBtn.addEventListener('click', function(e) {
    e.preventDefault();
    clearTimeout(searchTimeout);
    applyFilters();
  });

  clearFiltersBtn.addEventListener('click', function(e) {
    e.preventDefault();
    clearTimeout(searchTimeout);
    clearFilters();
  });

  prevPageBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (currentPage > 1 && !isLoading) {
      currentPage--;
      fetchParkingHistory();
    }
  });

  nextPageBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (currentPage < totalPages && !isLoading && totalPages > 0) {
      currentPage++;
      fetchParkingHistory();
    }
  });

  sortableHeaders.forEach(header => {
    header.addEventListener('click', function() {
      sortSessions(this.getAttribute('data-sort'));
    });
  });

  // Initialize
  fetchParkingHistory();
})();
</script>

<!-- Account Modal -->
<div class="modal-overlay" id="accountModal">
  <div class="account-modal">
    <div class="modal-header">
      <h3 class="modal-title">Account</h3>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label class="field-label">Full Name</label>
        <input type="text" class="field-input" value="{{ full_name|default:'Admin User' }}" readonly>
      </div>
      <div class="form-field">
        <label class="field-label">Username</label>
        <input type="text" class="field-input" value="{{ username|default:'admin' }}" readonly>
      </div>
      <div class="form-field">
        <label class="field-label">Email</label>
        <input type="email" class="field-input" value="{{ email|default:'admin@parkit.com' }}" readonly>
      </div>
    </div>
    <div class="modal-footer">
      <form method="post" action="{% url 'logout' %}" style="margin:0;">
        {% csrf_token %}
        <button type="submit" class="logout-btn-modal">Logout</button>
      </form>
    </div>
  </div>
</div>

<script>
  const profileTrigger = document.getElementById('profileTrigger');
  const accountModal = document.getElementById('accountModal');
  const closeModal = document.getElementById('closeModal');

  if (profileTrigger && accountModal) {
    profileTrigger.addEventListener('click', () => accountModal.classList.add('show'));
  }
  if (closeModal && accountModal) {
    closeModal.addEventListener('click', () => accountModal.classList.remove('show'));
  }
  if (accountModal) {
    accountModal.addEventListener('click', (e) => {
      if (e.target === accountModal) accountModal.classList.remove('show');
    });
  }
</script>

{% endblock %}
