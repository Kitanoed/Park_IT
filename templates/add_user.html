{% extends "base.html" %}

{% block title %}Admin - Add User{% endblock %}

{% block content %}
<style>
  .add-user-wrap{
    max-width: 720px;
    margin: 40px auto;
    padding: 24px 24px 28px;
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 10px 25px rgba(15,23,42,0.06);
  }
  .add-user-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:18px;
  }
  .add-user-title{
    font-size:18px;
    font-weight:700;
    color:#111827;
  }
  .add-user-sub{
    font-size:13px;
    color:#6b7280;
  }
  .add-user-form{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px 18px;
    margin-top:10px;
  }
  .add-user-form .full-row{
    grid-column:1 / -1;
  }
  .add-label{
    display:block;
    font-size:13px;
    font-weight:600;
    color:#111827;
    margin-bottom:6px;
  }
  .add-input,
  .add-select{
    width:100%;
    padding:9px 11px;
    border-radius:10px;
    border:1px solid #e5e7eb;
    font-size:14px;
    background:#f9fafb;
  }
  .add-input:focus,
  .add-select:focus{
    outline:none;
    border-color:#b71c1c;
    background:#ffffff;
  }
  .add-actions{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-top:22px;
  }
  .btn-secondary{
    padding:9px 16px;
    border-radius:10px;
    border:1px solid #e5e7eb;
    background:#ffffff;
    font-size:14px;
    font-weight:600;
    color:#374151;
    cursor:pointer;
  }
  .btn-primary{
    padding:9px 18px;
    border-radius:10px;
    border:none;
    background:linear-gradient(135deg,#b71c1c 0%,#f57c00 100%);
    color:#ffffff;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
  }
  .alert-stack{
    margin-bottom:16px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .alert-msg{
    padding:12px 14px;
    border-radius:12px;
    font-size:13px;
    font-weight:600;
    border:1px solid transparent;
  }
  .alert-msg.success{
    background:#ecfdf3;
    border-color:#bbf7d0;
    color:#166534;
  }
  .alert-msg.error,
  .alert-msg.danger{
    background:#fef2f2;
    border-color:#fecaca;
    color:#991b1b;
  }
  .alert-msg.warning{
    background:#fffbeb;
    border-color:#fde68a;
    color:#92400e;
  }
  .alert-msg.info{
    background:#eff6ff;
    border-color:#bfdbfe;
    color:#1e3a8a;
  }

  /* Notifications */
  .notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .notification {
    background: #ffffff;
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    min-width: 320px;
    max-width: 420px;
    display: flex;
    align-items: center;
    gap: 14px;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid;
  }

  .notification.success { border-left-color: #10b981; }
  .notification.error { border-left-color: #e53935; }

  .notification-icon {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
  }

  .notification.success .notification-icon { background: #d1fae5; color: #047857; }
  .notification.error .notification-icon { background: #fee2e2; color: #b91c1c; }

  .notification-message {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: #111827;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }

  .notification.hiding { animation: slideOut 0.3s ease-out forwards; }
</style>

<div class="add-user-wrap">
  <div class="add-user-header">
    <div>
      <div class="add-user-title">Add New User</div>
      <div class="add-user-sub">
        Create a new account with full name, username, email, and role.
      </div>
    </div>
  </div>

  <form method="post" id="addUserForm">
    {% csrf_token %}
    <div class="add-user-form">
      <div>
        <label class="add-label">First Name</label>
        <input
          type="text"
          name="first_name"
          class="add-input"
          value="{{ form_first_name|default:'' }}"
          required
        />
      </div>
      <div>
        <label class="add-label">Last Name</label>
        <input
          type="text"
          name="last_name"
          class="add-input"
          value="{{ form_last_name|default:'' }}"
          required
        />
      </div>
      <div class="full-row">
        <label class="add-label">Username (ID)</label>
        <input
          type="text"
          name="username"
          class="add-input"
          value="{{ form_username|default:'' }}"
          required
        />
      </div>
      <div class="full-row">
        <label class="add-label">Email</label>
        <input
          type="email"
          name="email"
          class="add-input"
          value="{{ form_email|default:'' }}"
          required
        />
      </div>
      <div class="full-row">
        <label class="add-label">Role</label>
        <select name="role" class="add-select" required>
          <option value="" disabled {% if not form_role %}selected{% endif %}>Select role</option>
          {% for r in roles %}
            <option value="{{ r.role }}" {% if r.role == form_role %}selected{% endif %}>
              {{ r.role_name|title }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="add-actions">
      <a href="{% url 'manage_users' %}" class="btn-secondary">Cancel</a>
      <button type="submit" class="btn-primary">Create User</button>
    </div>
  </form>
</div>

<!-- Notification Container -->
<div class="notification-container" id="notificationContainer"></div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) return token.value;
    return getCookie('csrftoken');
  }

  function showNotification(message, type = 'success') {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icon = document.createElement('div');
    icon.className = 'notification-icon';
    icon.innerHTML = type === 'success' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'notification-message';
    messageDiv.textContent = message;
    
    notification.appendChild(icon);
    notification.appendChild(messageDiv);
    container.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('hiding');
      setTimeout(() => notification.parentNode?.removeChild(notification), 300);
    }, 4000);
  }

  document.getElementById('addUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    
    // Disable submit button
    submitButton.disabled = true;
    submitButton.textContent = 'Creating...';
    
    try {
      const response = await fetch('{% url "add_user" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        showNotification(data.message || 'User created successfully!', 'success');
        // Clear form
        form.reset();
        // Redirect after a short delay
        setTimeout(() => {
          window.location.href = '{% url "manage_users" %}';
        }, 1500);
      } else {
        showNotification(data.error || 'Failed to create user', 'error');
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    } catch (error) {
      showNotification('An error occurred. Please try again.', 'error');
      submitButton.disabled = false;
      submitButton.textContent = originalText;
    }
  });
</script>

{% endblock %}


