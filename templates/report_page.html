{% extends "base.html" %}
{% load static %}

{% block title %}Admin - Advanced Reports{% endblock %}

{% block content %}
<style xmlns:lot.id xmlns:lot.id>
  :root{
    --brand-red:#b71c1c;
    --brand-orange:#f57c00;
    --win-red:#ff5f57;
    --win-yellow:#ffbd2e;
    --win-green:#28c840;
    --bar-red:#e53935;
    --bar-yellow:#ffb400;
    --bar-green:#2fbf4a;
    --surface:#ffffff;
    --border:#eef0f3;
    --text:#111827;
    --muted:#6b7280;
    --canvas-bg:#f5f7fa;
  }

  body{ background:var(--canvas-bg); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }

  .dashboard-wrap{
    width:100%;
    max-width: 1520px;
    margin:0 auto;
    padding:18px 18px 26px;
  }

  .app{
    display:grid;
    grid-template-columns: 270px 1fr;
    gap:14px;
    min-height: calc(100vh - 80px);
  }

  /* Sidebar */
  .sidebar{
    background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;
    display:flex;flex-direction:column;gap:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);
  }

  .brand{
    padding-bottom:10px;border-bottom:1px solid var(--border);
    display: flex;flex-direction: column;gap: 8px;
  }

  .dots-container{display:flex;gap:6px;align-items:center;}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.red{background:var(--win-red)}
  .dot.yellow{background:var(--win-yellow)}
  .dot.green{background:var(--win-green)}

  .park-brand{
    font-family: Montserrat, sans-serif;
    font-weight:800;
    letter-spacing:.2px;
    font-size:17px;
    line-height:1;
  }
  .park-brand .p1{ color:var(--brand-red); }
  .park-brand .p2{ color:#ffb400; }
  .brand-subtitle{font-weight:600;color:var(--muted);font-size:11px; margin-top:2px;}

  .nav{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .nav a{
    display:flex;align-items:center;gap:10px;text-decoration:none;
    padding:11px 12px;border-radius:12px;border:1px solid var(--border);
    color:var(--text); background:#fff; transition:.2s;
  }
  .nav a:hover{transform:translateY(-1px); border-color:var(--brand-red); color:var(--brand-red)}
  .nav a.active{
    background: linear-gradient(135deg,var(--brand-red) 0%, var(--brand-orange) 100%);
    color:#fff; border-color:transparent;
  }
  .ico{
    width:28px;height:28px;border-radius:8px;background:#f8f9fa;
    display:flex;align-items:center;justify-content:center;color:#6b7280;font-weight:700;
  }

  /* Main Content */
  .main{display:flex;flex-direction:column;gap:20px;}

  .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
  .page-title{font-size:28px;font-weight:700;color:var(--text);margin:0;}
  .page-subtitle{color:var(--muted);font-size:14px;margin-top:4px;}

  /* Card */
  .card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
  }

  /* Stats Grid */
  .stats-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap:16px;
  }

  .stat-card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    transition:.2s;
  }
  .stat-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08);}

  .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;}
  .stat-label{font-size:13px;font-weight:500;color:var(--muted);}
  .stat-icon{
    width:48px;height:48px;border-radius:12px;
    background: linear-gradient(135deg,var(--brand-red), var(--brand-orange));
    display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;
  }
  .stat-value{font-size:32px;font-weight:700;color:var(--text);margin:8px 0;}
  .stat-trend{font-size:12px;font-weight:600;}
  .stat-trend.up{color:var(--win-green);}
  .stat-trend.down{color:var(--win-red);}

  /* Button */
  .btn{
    padding:10px 20px;
    border-radius:10px;
    border:none;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    transition:.2s;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .btn-primary{
    background: linear-gradient(135deg,var(--brand-red), var(--brand-orange));
    color:#fff;
  }
  .btn-primary:hover{opacity:.9;transform:translateY(-1px);}

  /* Filters */
  .filters{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-top:16px;}
  .filter-group{display:flex;flex-direction:column;gap:8px;}
  .filter-label{font-size:13px;font-weight:600;color:var(--muted);}
  .filter-input, .filter-select{
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:8px;
    font-size:14px;
    color:var(--text);
  }
  .filter-input:focus, .filter-select:focus{
    outline:none;
    border-color:var(--brand-red);
  }

  /* Table */
  .table-container{overflow-x:auto;margin-top:16px;}
  .data-table{width:100%;border-collapse:collapse;}
  .data-table th{
    text-align:left;
    padding:12px 16px;
    border-bottom:2px solid var(--border);
    font-size:12px;
    font-weight:700;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.5px;
  }
  .data-table td{
    padding:14px 16px;
    border-bottom:1px solid var(--border);
    font-size:14px;
    color:var(--text);
  }
  .data-table tr:hover{background:#f9fafb;}

  /* Status Badge */
  .status-badge{
    display:inline-block;
    padding:4px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
  }
  .status-completed{background:#d1fae5;color:#065f46;}
  .status-active{background:#fef3c7;color:#92400e;}


  /* Chart Placeholder */
  .chart-container{
    height:300px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#f9fafb;
    border-radius:8px;
    margin-top:16px;
  }

  .charts-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap:20px;
  }
</style>

<div class="dashboard-wrap">
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="dots-container">
          <div class="dot red"></div>
          <div class="dot yellow"></div>
          <div class="dot green"></div>
        </div>
        <div>
          <div class="park-brand">
            <span class="p1">Park</span><span class="p2">IT!</span>
          </div>
          <div class="brand-subtitle">Smart Parking Management</div>
        </div>
      </div>

      <nav class="nav">
        <a href="{% url 'dashboard' %}">
          <div class="ico">üìä</div>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'reports' %}" class="active">
          <div class="ico">üìÑ</div>
          <span>Advanced Reports</span>
        </a>
        <a href="{% url 'admin_parking_history' %}">
          <div class="ico">üìã</div>
          <span>Parking History</span>
        </a>
        <a href="{% url 'parking_spaces' %}">
          <div class="ico">üÖøÔ∏è</div>
          <span>Parking Spaces</span>
        </a>
        <a href="{% url 'manage_users' %}">
          <div class="ico">üë•</div>
          <span>Manage Users</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">Advanced Reports</h1>
          <p class="page-subtitle">Comprehensive parking analytics and insights</p>
        </div>
        <button class="btn btn-primary" onclick="exportToCSV()">
          <span>üì•</span>
          Export CSV
        </button>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-label">Total Parking Sessions</div>
            </div>
            <div class="stat-icon">üöó</div>
          </div>
          <div class="stat-value">{{ total_sessions|default:"0" }}</div>
          <div class="stat-trend up">‚Üë +{{ session_trend|default:"0" }}%</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-label">Avg. Duration</div>
            </div>
            <div class="stat-icon">‚è±Ô∏è</div>
          </div>
          <div class="stat-value">{{ avg_duration|default:"0h" }}</div>
          <div class="stat-trend down">‚Üì -{{ duration_trend|default:"0" }}%</div>
        </div>
      </div>

      <!-- Filters Card -->
      <div class="card">
        <div class="section-title">
          üîç Filters
        </div>
        <form method="GET" action="{% url 'reports' %}">
          <div class="filters">
            <div class="filter-group">
              <label class="filter-label">Date Range</label>
              <select name="date_range" class="filter-select">
                <option value="7" {% if date_range =="7" %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if date_range =="30" %}selected{% endif %}>Last 30 days</option>
                <option value="90" {% if date_range =="90" %}selected{% endif %}>Last 90 days</option>
                <option value="365" {% if date_range =="365" %}selected{% endif %}>Last year</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Parking Lot</label>
              <select name="lot_id" class="filter-select">
                <option value="">All Lots</option>
                {% for lot in parking_lots %}
                <option value="{{ lot.id }}" {% if selected_lot ==lot.id|stringformat:"s" %}selected{% endif %}>
                  {{ lot.name }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Search Vehicle</label>
              <input type="text" name="vehicle" class="filter-input" placeholder="Enter license plate..." value="{{ vehicle_search|default:'' }}">
            </div>

            <div class="filter-group">
              <label class="filter-label" style="opacity:0;">Action</label>
              <button type="submit" class="btn btn-primary" style="width:100%;">Apply Filters</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Charts Grid (Removed Revenue Chart) -->
      <div class="charts-grid">
        <!-- Monthly Usage Chart -->
        <div class="card">
          <div class="section-title">
            üìÖ Monthly Usage Trends
          </div>
          <div class="chart-container">
            <canvas id="usageChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Detailed Logs Table -->
      <div class="card">
        <div class="section-title">
          üìã Detailed Parking Logs
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Parking ID</th>
                <th>Vehicle</th>
                <th>Lot</th>
                <th>Entry Time</th>
                <th>Exit Time</th>
                <th>Duration</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for log in parking_logs %}
              <tr>
                <td><code>{{ log.id }}</code></td>
                <td><strong>{{ log.vehicle_plate }}</strong></td>
                <td>{{ log.lot_name }}</td>
                <td>{{ log.entry_time|date:"Y-m-d H:i" }}</td>
                <td>{% if log.exit_time %}{{ log.exit_time|date:"Y-m-d H:i" }}{% else %}‚Äî{% endif %}</td>
                <td>{{ log.duration|default:"In Progress" }}</td>

                  <span class="status-badge status-{{ log.status_class }}">
                    {{ log.status }}
                  </span>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" style="text-align:center;color:var(--muted);">No parking logs found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Monthly Usage Chart
  const usageCtx = document.getElementById('usageChart');
  if (usageCtx) {
    new Chart(usageCtx, {
      type: 'line',
      data: {
        labels: {{ monthly_labels|safe }},
        datasets: [{
          label: 'Parking Sessions',
          data: {{ monthly_usage|safe }},
          borderColor: '#b71c1c',
          backgroundColor: 'rgba(183, 28, 28, 0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Export to CSV function
  function exportToCSV() {
    const table = document.querySelector('.data-table');
    let csv = [];
    const rows = table.querySelectorAll('tr');

    for (let row of rows) {
      const cols = row.querySelectorAll('td, th');
      const csvrow = [];
      for (let col of cols) {
        csvrow.push('"' + col.innerText.replace(/"/g, '""') + '"');
      }
      csv.push(csvrow.join(','));
    }

    const csvString = csv.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'parking-logs-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
  }
</script>

{% endblock %}
