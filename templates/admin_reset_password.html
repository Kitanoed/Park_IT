{% extends "base.html" %}
{% load static %}

{% block title %}Admin - Reset User Password{% endblock %}

{% block content %}
<style>
  :root{
    --brand-red:#b71c1c;
    --brand-orange:#f57c00;
    --surface:#ffffff;
    --border:#eef0f3;
    --text:#111827;
    --muted:#6b7280;
    --canvas-bg:#f5f7fa;
  }

  body{ background:var(--canvas-bg); }

  .dashboard-wrap{
    width:100%;
    max-width: 1520px;
    margin:0 auto;
    padding:18px 18px 26px;
  }

  .app{
    display:grid;
    grid-template-columns: 270px 1fr;
    gap:14px;
    min-height: calc(100vh - 80px);
  }

  .sidebar{
    background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;
    display:flex;flex-direction:column;gap:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);
  }

  .brand{
    padding-bottom:10px;border-bottom:1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .dots-container{
    display:flex;
    gap:6px;
    align-items:center;
  }
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.red{background:#ff5f57}
  .dot.yellow{background:#ffbd2e}
  .dot.green{background:#28c840}

  .txt{line-height:1.1;}
  .park-brand{
    font-family: Montserrat, sans-serif;
    font-weight:800;
    letter-spacing:.2px;
    font-size:17px;
    line-height:1;
  }
  .park-brand .p1{ color:var(--brand-red); }
  .park-brand .p2{ color:#ffb400; }
  .txt .t2{font-weight:600;color:var(--muted);font-size:11px; margin-top:2px;}

  .nav{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .nav a{
    display:flex;align-items:center;gap:10px;text-decoration:none;
    padding:11px 12px;border-radius:12px;border:1px solid var(--border);
    color:var(--text); background:#fff; transition:.2s;
  }
  .nav a:hover{transform:translateY(-1px); border-color:var(--brand-red); color:var(--brand-red)}
  .nav a.active{
    background: linear-gradient(135deg,var(--brand-red) 0%, var(--brand-orange) 100%);
    color:#fff; border-color:transparent;
  }
  .ico{
    width:28px;height:28px;border-radius:8px;background:#f8f9fa;
    display:flex;align-items:center;justify-content:center;color:#6b7280;font-weight:700;
  }
  .ico i {
    color: var(--text);
  }
  .nav a.active .ico i {
    color: #fff;
  }
  .spacer{flex:1}

  .profile{
    padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;
    display:flex;align-items:center;gap:10px;
  }
  .avatar{width:30px;height:30px;border-radius:50%;background:#f3f4f6}
  .nm{font-weight:600;font-size:12px;color:var(--text)}
  .em{font-size:11px;color:var(--muted)}

  .main{
    background:#fff;border:1px solid var(--border);border-radius:12px;
    box-shadow:0 1px 2px rgba(0,0,0,.04); padding:20px;
  }

  .page-header{
    margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border);
  }
  .page-title{font-size:20px;font-weight:700;color:var(--text);margin:0}
  .page-sub{font-size:13px;color:var(--muted);margin-top:4px}

  .user-info{
    background:#f8f9fa;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:20px;
  }
  .user-info-label{font-size:12px;color:var(--muted);margin-bottom:4px}
  .user-info-value{font-size:14px;font-weight:600;color:var(--text)}

  .form-field{margin-bottom:16px}
  .form-field:last-child{margin-bottom:0}
  .field-label{
    display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:8px;
  }
  .field-input{
    width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;
    font-size:14px;color:var(--text);background:#fff;font-family:inherit;
  }
  .field-input:focus{
    outline:none;border-color:var(--brand-red);box-shadow:0 0 0 3px rgba(183,28,28,.1);
  }
  .errorlist{
    list-style:none;padding:0;margin:8px 0 0;color:#dc2626;font-size:12px;
  }
  .errorlist li{margin-bottom:4px}
  .help-text{font-size:12px;color:var(--muted);margin-top:4px}

  .btn-row{display:flex;gap:10px;margin-top:20px}
  .btn-primary{
    padding:10px 20px;border:none;border-radius:8px;font-weight:700;font-size:14px;
    cursor:pointer;background:linear-gradient(135deg,var(--brand-red) 0%, var(--brand-orange) 100%);
    color:#fff;transition:.2s;
  }
  .btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
  .btn-ghost{
    padding:10px 20px;border:1px solid var(--border);border-radius:8px;
    background:#fff;font-size:13px;font-weight:600;color:var(--muted);
    cursor:pointer;transition:.2s;text-decoration:none;display:inline-block;
  }
  .btn-ghost:hover{border-color:var(--brand-red);color:var(--brand-red)}

  .alert-stack{
    margin-bottom:16px;display:flex;flex-direction:column;gap:8px;
  }
  .alert-msg{
    padding:12px 14px;border-radius:12px;font-size:13px;font-weight:600;
    border:1px solid transparent;
  }
  .alert-msg.success{
    background:#ecfdf3;border-color:#bbf7d0;color:#166534;
  }
  .alert-msg.error,.alert-msg.danger{
    background:#fef2f2;border-color:#fecaca;color:#991b1b;
  }

  @media (max-width: 1024px){
    .app{grid-template-columns: 1fr;}
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<script>
  document.getElementById('resetPasswordForm')?.addEventListener('submit', function(e) {
    const btn = document.getElementById('resetBtn');
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Generating Password...';
    }
  });
</script>

<div class="dashboard-wrap">
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="dots-container">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div class="txt">
          <div class="park-brand">
            <span class="p1">Park</span><span class="p2">IT!</span>
          </div>
          <div class="t2">Online</div>
        </div>
      </div>

      <nav class="nav">
        <a href="{% url 'dashboard' %}">
          <span class="ico">▦</span><span>Dashboard</span>
        </a>
        <a href="{% url 'parking_spaces' %}">
          <span class="ico"><i class="fas fa-parking"></i></span><span>Parking Spaces</span>
        </a>
        <a class="active" href="{% url 'manage_users' %}">
          <span class="ico"><i class="fas fa-users"></i></span><span>Manage Users</span>
        </a>
      </nav>

      <div class="spacer"></div>

      <div class="profile">
        <div class="avatar"></div>
        <div>
          <div class="nm">{{ full_name|default:"User Name" }}</div>
          <div class="em">{{ email|default:"user email" }}</div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <section class="main">
      {% if messages %}
      <div class="alert-stack">
        {% for message in messages %}
          <div class="alert-msg {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="page-header">
        <h2 class="page-title">Reset User Password</h2>
        <div class="page-sub">Generate a secure temporary password for this user</div>
      </div>

      <div class="user-info">
        <div class="user-info-label">User</div>
        <div class="user-info-value">
          {{ target_user.first_name }} {{ target_user.last_name }}
          {% if target_user.student_employee_id %}
            ({{ target_user.student_employee_id }})
          {% endif %}
        </div>
        {% if target_user.email %}
        <div class="user-info-label" style="margin-top:8px">Email</div>
        <div class="user-info-value">{{ target_user.email }}</div>
        {% endif %}
      </div>

      {% if temp_password %}
      <!-- Show temporary password once after reset -->
      <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
          <div style="width: 32px; height: 32px; border-radius: 50%; background: #0ea5e9; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700;">
            <i class="fas fa-key"></i>
          </div>
          <div>
            <div style="font-weight: 700; color: #0c4a6e; font-size: 16px;">Password Reset Successful</div>
            <div style="font-size: 12px; color: #0369a1; margin-top: 2px;">A secure temporary password has been generated</div>
          </div>
        </div>
        
        <div style="background: white; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin-top: 16px;">
          <div style="font-size: 12px; font-weight: 600; color: #0369a1; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Temporary Password</div>
          <div style="font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: #0c4a6e; letter-spacing: 2px; padding: 12px; background: #f8fafc; border-radius: 6px; text-align: center; border: 1px dashed #bae6fd;">
            {{ temp_password }}
          </div>
          <div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 4px;">
              <i class="fas fa-exclamation-triangle"></i> Important Security Notice
            </div>
            <div style="font-size: 12px; color: #78350f; line-height: 1.5;">
              • Share this password securely with {{ temp_password_user|default:"the user" }}<br>
              • The user should change this password immediately after logging in<br>
              • This password will only be shown once - copy it now
            </div>
          </div>
        </div>
        
        <div class="btn-row" style="margin-top: 20px;">
          <a href="{% url 'manage_users' %}" class="btn-primary" style="text-decoration: none; display: inline-block;">
            <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>
            Back to Users
          </a>
        </div>
      </div>
      {% else %}
      <!-- Reset password form -->
      <div style="background: #f8f9fa; border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 16px;">
          <div style="width: 24px; height: 24px; border-radius: 50%; background: #dbeafe; color: #1e40af; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; margin-top: 2px;">
            <i class="fas fa-info-circle"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text); font-size: 14px; margin-bottom: 4px;">How Password Reset Works</div>
            <div style="font-size: 12px; color: var(--muted); line-height: 1.6;">
              Clicking "Generate & Reset Password" will create a secure, randomly generated temporary password. 
              This password will be displayed once for you to share with the user. The user should change it immediately after logging in.
            </div>
          </div>
        </div>
      </div>

      <form method="post" action="{% url 'admin_reset_password' target_user.id %}" id="resetPasswordForm">
        {% csrf_token %}
        {{ form.confirm_reset }}

        {% if form.non_field_errors %}
          <ul class="errorlist">
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}

        <div class="btn-row">
          <button type="submit" class="btn-primary" id="resetBtn">
            <i class="fas fa-key" style="margin-right: 8px;"></i>
            Generate & Reset Password
          </button>
          <a href="{% url 'manage_users' %}" class="btn-ghost">Cancel</a>
        </div>
      </form>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}

